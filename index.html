<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Aplaus√≥metro PRO - Evento</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #050505;
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Pantalla de Inicio (Overlay) */
        #start-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #start-screen h1 { font-size: 3rem; margin-bottom: 20px; color: #00ffcc; }
        #start-screen p { font-size: 1.5rem; color: #aaa; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        /* Animaci√≥n de Temblor */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking { animation: shake 0.5s infinite; }

        /* Estructura del juego */
        h2 { margin: 0; font-size: 2rem; letter-spacing: 3px; opacity: 0.8; }
        #winner-text { height: 60px; font-size: 3.5rem; color: gold; text-shadow: 0 0 20px orange; margin: 10px 0; font-weight: bold;}

        .stage {
            display: flex; width: 90%; height: 55%; gap: 30px;
            justify-content: center; align-items: flex-end; position: relative;
        }

        .team-column {
            flex: 1; height: 100%;
            background: #1a1a1a; border-radius: 20px;
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: flex-end;
            border: 3px solid #333; transition: all 0.3s;
        }
        .team-column.active-turn { border-color: white; box-shadow: 0 0 40px rgba(255,255,255,0.15); }
        .team-column.winner { border-color: #ffd700; box-shadow: 0 0 60px #ffd700; z-index: 10; transform: scale(1.03); }

        .bar { width: 100%; height: 0%; transition: height 0.1s linear; display: flex; align-items: flex-start; justify-content: center; padding-top: 15px; font-size: 4rem; font-weight: 900; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        #bar-a { background: linear-gradient(to top, #006400, #00ff00); color: #eaffea; }
        #bar-b { background: linear-gradient(to top, #640000, #ff0000); color: #ffeaea; }

        .label { position: absolute; bottom: 20px; width: 100%; font-size: 2.5rem; font-weight: bold; text-shadow: 2px 2px 4px black; z-index: 10; }

        /* Timer Overlay */
        #timer-overlay { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 10rem; font-weight: 900; color: white; text-shadow: 0 0 30px black; display: none; z-index: 100; pointer-events: none; }

        /* Controles */
        .controls { margin-top: 20px; padding: 15px; background: #222; border-radius: 12px; border: 1px solid #444; display: flex; gap: 15px; align-items: center; }
        button { padding: 12px 25px; font-size: 1.1rem; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-a { background-color: #00cc00; color: black; }
        .btn-b { background-color: #cc0000; color: white; }
        .btn-reset { background-color: #555; color: white; }

        /* Slider de Sensibilidad */
        .slider-container { display: flex; flex-direction: column; margin-left: 20px; border-left: 1px solid #555; padding-left: 20px; }
        .slider-container label { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
        input[type=range] { width: 150px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="start-screen" onclick="unlockAudio()">
        <h1>üîà SISTEMA DE VOTACI√ìN</h1>
        <p>Hacer clic en cualquier parte para activar micr√≥fono</p>
    </div>

    <h2>¬øQUI√âN GRITA M√ÅS FUERTE?</h2>
    <div id="winner-text"></div>

    <div class="stage">
        <div id="timer-overlay">5</div>
        <div class="team-column" id="col-a">
            <div class="label">CAMINO A</div>
            <div id="bar-a" class="bar">0</div>
        </div>
        <div class="team-column" id="col-b">
            <div class="label">CAMINO B</div>
            <div id="bar-b" class="bar">0</div>
        </div>
    </div>

    <div class="controls">
        <button onclick="startCountdown('A')" class="btn-a" id="btn-a">‚è±Ô∏è TURNO A</button>
        <button onclick="startCountdown('B')" class="btn-b" id="btn-b" disabled>‚è±Ô∏è TURNO B</button>
        <button onclick="resetAll()" class="btn-reset">üîÑ Reiniciar</button>

        <div class="slider-container">
            <label>Sensibilidad Micr√≥fono: <span id="sens-val">1.5</span></label>
            <input type="range" id="sensitivity" min="0.1" max="5.0" step="0.1" value="1.5" oninput="updateSensitivity(this.value)">
        </div>
    </div>

<script>
    let audioContext;
    let analyser;
    let microphone;
    let javascriptNode;
    let isListening = false;
    let currentTeam = null;
    let scoreA = 0;
    let scoreB = 0;
    
    // Configuraci√≥n
    const GAME_DURATION = 5; // segundos de grito
    let SENSITIVITY = 1.5;   // Valor inicial

    // 1. DESBLOQUEO INICIAL (Soluciona problemas de permisos)
    async function unlockAudio() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.6;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            javascriptNode.onaudioprocess = processAudio;

            // Ocultar pantalla de inicio
            document.getElementById('start-screen').style.display = 'none';
        } catch (e) {
            alert("Error: No se pudo acceder al micr√≥fono. Verifica los permisos en el candado de la URL.");
            console.error(e);
        }
    }

    function updateSensitivity(val) {
        SENSITIVITY = parseFloat(val);
        document.getElementById('sens-val').innerText = val;
    }

    function processAudio() {
        if (!isListening || !currentTeam) return;

        const array = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(array);
        let values = 0;
        for (let i = 0; i < array.length; i++) values += array[i];
        
        // Aqu√≠ aplicamos la sensibilidad ajustable
        let volume = Math.round((values / array.length) * SENSITIVITY); 
        
        // Limites visuales 0-100
        if (volume > 100) volume = 100;

        // Screen Shake
        if (volume > 85) document.body.classList.add('shaking');
        else document.body.classList.remove('shaking');

        updateGame(volume);
    }

    function updateGame(volume) {
        const bar = document.getElementById(`bar-${currentTeam.toLowerCase()}`);
        bar.style.height = volume + "%";
        bar.innerText = volume;

        if (currentTeam === 'A' && volume > scoreA) scoreA = volume;
        if (currentTeam === 'B' && volume > scoreB) scoreB = volume;
    }

    function startCountdown(team) {
        // Asegurarse de que el audioContext est√© activo (por si acaso)
        if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume();
        }

        // UI
        document.getElementById('btn-a').disabled = true;
        document.getElementById('btn-b').disabled = true;
        document.querySelectorAll('.team-column').forEach(c => c.classList.remove('active-turn'));
        document.getElementById(`col-${team.toLowerCase()}`).classList.add('active-turn');
        
        const timerDisplay = document.getElementById('timer-overlay');
        timerDisplay.style.display = 'block';
        
        let countdown = 3;
        timerDisplay.innerText = "¬°LISTOS!";
        
        let prepInterval = setInterval(() => {
            if(countdown > 0) {
                timerDisplay.innerText = countdown;
                countdown--;
            } else {
                clearInterval(prepInterval);
                timerDisplay.innerText = "¬°GRITEN!";
                startRecording(team);
            }
        }, 1000);
    }

    function startRecording(team) {
        isListening = true;
        currentTeam = team;
        let timeLeft = GAME_DURATION;
        const timerDisplay = document.getElementById('timer-overlay');

        let gameInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(gameInterval);
                stopRecording(team);
            }
        }, 1000);
    }

    function stopRecording(team) {
        isListening = false;
        document.body.classList.remove('shaking');
        document.getElementById('timer-overlay').style.display = 'none';

        // Fijar puntaje
        const finalScore = (team === 'A') ? scoreA : scoreB;
        const bar = document.getElementById(`bar-${team.toLowerCase()}`);
        bar.style.height = finalScore + "%";
        bar.innerText = finalScore;

        if (team === 'A') {
            document.getElementById('btn-b').disabled = false;
            document.getElementById(`col-a`).classList.remove('active-turn');
        } else {
            document.getElementById(`col-b`).classList.remove('active-turn');
            declareWinner();
        }
        currentTeam = null;
    }

    function declareWinner() {
        const winnerText = document.getElementById('winner-text');
        
        if (scoreA > scoreB) {
            winnerText.innerText = "¬°GANA CAMINO A!";
            document.getElementById('col-a').classList.add('winner');
            launchConfetti();
        } else if (scoreB > scoreA) {
            winnerText.innerText = "¬°GANA CAMINO B!";
            document.getElementById('col-b').classList.add('winner');
            launchConfetti();
        } else {
            winnerText.innerText = "¬°EMPATE!";
        }
    }

    function launchConfetti() {
        var duration = 3 * 1000;
        var end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 5,
                angle: 60,
                spread: 55,
                origin: { x: 0 }
            });
            confetti({
                particleCount: 5,
                angle: 120,
                spread: 55,
                origin: { x: 1 }
            });

            if (Date.now() < end) {
                requestAnimationFrame(frame);
            }
        }());
    }

    function resetAll() {
        isListening = false;
        currentTeam = null;
        scoreA = 0; scoreB = 0;
        document.getElementById('bar-a').style.height = "0%";
        document.getElementById('bar-a').innerText = "0";
        document.getElementById('bar-b').style.height = "0%";
        document.getElementById('bar-b').innerText = "0";
        document.getElementById('btn-a').disabled = false;
        document.getElementById('btn-b').disabled = true;
        document.getElementById('winner-text').innerText = "";
        document.querySelectorAll('.team-column').forEach(c => {
            c.classList.remove('active-turn', 'winner');
        });
    }
</script>
</body>
</html>
